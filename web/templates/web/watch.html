{% extends 'web/base.html' %}
{% load static %}
{% load compress %}
{% load humanize %}

{% block title %}
	<title>{{ video.title }} - Tracle</title>
{% endblock %}

{% block css %}
	<link href="{% static 'web/css/video-js.css' %}" rel="stylesheet" />
	<link rel="stylesheet" type="text/x-scss" href="{% static 'web/scss/watch.scss' %}">
{% endblock css %}

{% block body %}
	<div class="container">
		{% include 'web/includes/nav.html' %}
		{% if not video %}
			<div class="primary">
				<h2 style="text-align: center;margin-top: 10em;">Video not found</h2>
			</div>
		{% else %}
		<div class="header">
			<h2>{{ video.title }}
			{% if user.is_admin %}<a href="/admin/backend/video/{{ video.id }}/change/" style="font-size: 1rem; color: #333"><i class="far fa-edit"></i></a>{% endif %}
			</h2>
			<button class="btn btn-gray" onclick="location.href='{% url "web_channel" video.channel.channel_id %}'">{{ video.channel.name }}</button>
			<button  id="btn-subscribe" class="btn btn-gray" {% if not request.user.is_authenticated or request.channel.channel_id == video.channel.channel_id %} disabled {% else %} onclick="toggleSubscribe()" {% endif %}><i class="fas fa-plus-circle"></i> <span id="btn-subscribe-text">{% if request.user.is_authenticated and is_subscribed %} Unsubscribe {% else %} Subscribe {% endif %}</span></button>
		</div>
		<div class="primary">
			<div class="video__container">
				<video-js id="player" class="video-js vjs-big-play-centered vjs-show-big-play-button-on-pause" controls preload="auto" poster="{{ video.get_poster }}">
					<p class="vjs-no-js">
						To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
					</p>
				</video-js>
			</div>
			<div class="panel">
				<div class="panel__actions">
					<div class="panel__actions__left">
						<div class="panel__actions__like">
							<button id='btn-like' class="btn btn-gray btn-like {% if is_liked %} active {% endif %}" {% if request.user.is_authenticated %} onclick="like()" {% else %} disabled {% endif %}><i class="fas fa-thumbs-up"></i></button><button id="btn-dislike" class="btn btn-gray btn-dislike {% if is_disliked %} active {% endif %}" {% if request.user.is_authenticated %} onclick="dislike()" {% else %} disabled {% endif %}><i class="fas fa-thumbs-down"></i></button>
						</div>
						<button class="btn btn-gray btn-addto"><i class="fas fa-plus"></i></button>
						<button class="btn btn-gray">Share</button>
						<button class="btn btn-gray"><i class="fas fa-flag"></i></button>
					</div>
					<div class="panel__actions__right">
						<div class="panel__actions__views"><span id="view_count">{{ video.views }}</span> views</div>
						<button class="btn btn-gray"><i class="fa fa-chart-bar"></i></button>
					</div>
				</div>
				<div id="panel-details" class="panel__details panel__details--collapsed">
					<div class="panel__details__left">
						<div class="panel__details__uploader">Uploaded by <a href="{% url 'web_channel' video.channel.channel_id %}">{{ video.channel.name }}</a> on {{ video.created|naturaltime }}</div>
						<div class="panel__details__description">{{ video.description|linebreaks }}</div>
						<div class="panel__details__minor">
							<strong>Category:</strong><br>
							{{ video.category }}<br>
							<strong>License:</strong><br>
							PLAcEHOLDER
						</div>
					</div>
					<div class="panel__details__right">
						<div class="panel__details__likebar">
							<div id="likebar" class="panel__details__likebar__likes" style="width: {{ likebar_value }}%"></div>
						</div>
						<div class="panel__details__likes"><span id="like-counter">{{ video.likes.count }}</span> likes, <span id="dislike-counter">{{ video.dislikes.count }}</span> dislikes</div>
					</div>
				</div>
				<div class="panel__expander" onclick="toggleExpander()">
					<div id="panel_expander_text" class="panel__expander__button">Show more</div>
				</div>
			</div>
			<div id="app" data-authenticated="{{ request.user.is_authenticated }}">
			</div>
		</div>
		{% endif %}
		<div class="secondary">
			{% include 'web/includes/secondary-feed.html' %}
		</div>
		{% include 'web/includes/footer.html' %}
	</div>
	{% csrf_token %}
	<input id="channel_id" type="hidden" value="{{ video.channel.channel_id }}">
	<input id="watch_id" type="hidden" name="watch_id" value="{{ video.watch_id }}">
{% endblock %}

{% block script %}
	<script src="{% static 'web/js/vendor/video.js' %}"></script>
	<script src="{% static 'web/js/vendor/videojs-landscape-fullscreen.min.js' %}"></script>
	<script>

		var player = videojs('player', {
			html5: {
		        hls: {
		        	// overrideNative: !videojs.browser.IS_ANY_SAFARI
		        	overrideNative: true
		      	}  
		    },
			aspectRatio: "16:9", 
			responsive: true,
			userActions: {
				doubleClick: true,
				hotkeys: true
			},
			controlBar: {
				children: [
					'playToggle',
					'currentTimeDisplay',
					'progressControl',
					'durationDisplay',
					'volumePanel',
					'fullscreenToggle'
				],
				volumePanel: {
				  inline: false
				}
			}
		});

		player.src({
			src: '{{ video.playlist_file.url }}',
			type: 'application/x-mpegURL'
		});

		player.landscapeFullscreen();

		function handlePlay() {
			const view_count = $('#view_count');
			const watch_id = $('#watch_id').val();
			const csrftoken = $("[name=csrfmiddlewaretoken").val();
			$.ajax({
				type: 'POST',
				url: '/api/incrementviews',
				data: {'watch_id' : watch_id},
				beforeSend: function (request) {
					request.setRequestHeader("X-CSRFToken", csrftoken);
				},
				error: function (result) {
					console.log(result);
				}
			});
		}

		player.one('play', handlePlay);

	</script>

	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="{% static 'web/js/vendor/humanized_time_span.js' %}"></script>
	<script>
		Vue.filter('humanTime', function (value) {
			return humanized_time_span(value);
		})

		Vue.component('comment-entry', {
			delimiters: ['[[', ']]'],
			props: ['comment'],
			data () {
				return {
					showReply: false,
					commentText: '',
					authenticated: "{{ request.user.is_authenticated }}",
					el: null,
				}
			},
			computed: {
				formId: function () {
					return 'reply-form-' + this.comment.id; 
				},
				commentId: function () {
					return 'comment-' + this.comment.id;
				},
				textId: function () {
					return 'id_text-' + this.comment.id;
				},
				remainingChars: function () {
					return 500 - this.commentText.length;
				},
				is_authenticated: function () {
					return this.authenticated === "True";
				},
				bodyId: function () {
					return 'comment-body-' + this.comment.id;
				},
				inputId: function () {
					return 'input-id-' + this.comment.id;
				},
				is_overflowing: function () {
					return this.el ? this.el.clientHeight < this.el.scrollHeight : false;
				}
			},
			mounted() {
				this.el = document.getElementById('comment-body-' + this.comment.id);
			},
			methods: {
				updateIsOverflowing() {
					if (this.$refs.replies) {
						this.$refs.replies.forEach(r => {
							r.el = null;
							r.el = document.getElementById('comment-body-' + r.comment.id);
						});
					}
				},
				showReplyForm() {
					if (!this.is_authenticated) {
						location.href='/signin';
						return;
					}
					this.showReply = true;
					document.getElementById(this.textId).focus();
					this.commentText = '@' + this.comment.author_name + ' ';
				},
				hideReplyForm() {
					this.showReply = false;
				},
				commentLike(event) {
					if (!this.is_authenticated) {
						location.href='/signin';
						return;
					}
					var csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
					var data = new FormData();
					data.append('comment_id', event.target.dataset.id);
					axios.post('/api/comments/like', data, {headers: {'X-CSRFToken' : csrftoken, 'Content-Type': 'multipart/form-data'}})
					.then(response => {
						this.comment.likes = response.data.likes;
						this.comment.dislikes = response.data.dislikes;
					})
					.catch(error => { console.log(error.message); });
				},
				commentDislike(event) {
					if (!this.is_authenticated) {
						location.href='/signin';
						return;
					}
					var csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
					var data = new FormData();
					data.append('comment_id', event.target.dataset.id);
					axios.post('/api/comments/dislike', data, {headers: {'X-CSRFToken' : csrftoken, 'Content-Type': 'multipart/form-data'}})
					.then(response => {
						this.comment.likes = response.data.likes;
						this.comment.dislikes = response.data.dislikes;
					})
					.catch(error => { console.log(error.message); });
				},
				postReply() {
					event.preventDefault();
					if (!this.is_authenticated) {
						location.href='/signin';
						return;
					}
					var csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
					var data = new FormData(document.getElementById(this.formId))
					data.append('parent_id', this.comment.id);
					axios.post('/api/comments/{{ video.watch_id }}', data, {headers: {'X-CSRFToken' : csrftoken, 'Content-Type': 'multipart/form-data'}})
					.then(response => {
						this.hideReplyForm();
						if (this.comment.parent) {
							this.$emit('addtoparent', response.data);
						}
						else {
							this.comment.replies.unshift(response.data);
						}
					})
					.catch(error => {
						console.log(error.message);
					});
				},
				onAddToParent(new_comment) {
					this.comment.replies.push(new_comment);
				}
			},
			template: `
				<div class=comment-container>
					<div v-bind:id="commentId" class="comment">
						<div class="comment__content">
							<input style="display: none;" type="checkbox" :id="comment.id">
							<div :id="bodyId" class="comment__content__body">
								<div v-for="line in comment.text.split('\\n')">[[ line ]]</div>
							</div>
							<label :style="[is_overflowing ? {display: 'inline-block'} : {display: 'none'}]" :for="comment.id" class="comment__content__more">
								Show 
							</label>
							<div class="comment__content__meta">
								<span><a href="#">[[ comment.author_name ]]</a></span>
								<span>[[ comment.created|humanTime ]]</span>
								<span class="comment__content__meta__likes">[[ comment.likes ]] <i class="fas fa-thumbs-up"></i></span>
								<span class="comment__content__meta__dislikes">[[ comment.dislikes ]] <i class="fas fa-thumbs-down"></i></span>
							</div>
						</div>
						<div class="comment__actions">
							<div class="comment__actions__like">
								<button v-bind:data-id="comment.id" class="btn btn-gray btn-like" @click="commentLike($event)"><i style="pointer-events:none;" class="fas fa-thumbs-up"></i></button><button v-bind:data-id="comment.id" class="btn btn-gray btn-dislike" @click="commentDislike($event)"><i style="pointer-events:none;" class="fas fa-thumbs-down"></i></button>
							</div>
							<button class="btn btn-gray btn-reply" @click="showReplyForm">Reply</button>
						</div>
					</div>
					<form v-bind:id="formId" class="reply-form" :style="[showReply ? {display: 'block'} : {display: 'none'}]" >
						<textarea v-bind:id="textId" name="text" class="reply-form__textbox" v-model="commentText"></textarea>
						<div class="reply-form__actions">
							<div :style="[remainingChars < 0 ? {color: 'red'} : {color: '#333'}]">[[ remainingChars ]] characters remaining</div>
							<div><span @click="hideReplyForm">Cancel</span> or <button class="btn btn-gray" @click="postReply($event)">Post</button></div>
						</div>
					</form>
					<div class="reply-container" v-if="comment.replies.length">
						<input type="checkbox" :id=inputId @click="updateIsOverflowing()">
						<label :for="inputId">[[ comment.replies.length ]] replies</label>
						<div class="reply-container__inner">
							<comment-entry ref="replies" v-on:addtoparent="onAddToParent" v-for="reply in comment.replies" v-bind:key="reply.id" v-bind:comment="reply"></comment-entry>
						</div>
					</div>
				</div>
			`
		});

		var app = new Vue({
			delimiters: ['[[', ']]'],
			el: '#app',
			data: {
				comments: [],
				commentText: '',
				authenticated: "{{ request.user.is_authenticated }}",
			},
			computed: {
				remainingChars: function () {
					return 500 - this.commentText.length;
				},
				is_authenticated: function () {
					return this.authenticated === "True";
				},
				totalComments: function () {
					num = this.comments.length;
					this.comments.forEach(comment => {
						num += comment.replies.length;
					})
					return num;
				},
			},
			mounted () {
				axios.get('/api/comments/{{ video.watch_id }}'
					).then(response => {
						this.comments = response.data
					}
					).catch(error => {
						console.log(error.message);
					}
				);
			},
			methods: {
				postComment() {
					event.preventDefault()
					var csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
					var data = new FormData(document.getElementById('comment-form'))
					axios.post('/api/comments/{{ video.watch_id }}', data, {headers: {'X-CSRFToken' : csrftoken, 'Content-Type': 'multipart/form-data'}})
					.then(response => {
						this.commentText = ''
						this.comments.unshift(response.data)
					})
					.catch(error => {
						console.log(error.message);
					});
				},
			},
			template: `
				<div id="comments" class="comments">
					<h4>All Comments ([[ totalComments ]])</h4>
					<form v-if="is_authenticated" id="comment-form" class="comment-form">
						<textarea id="id_text" name="text" class="comment-form__textbox" v-model="commentText"></textarea>
						<div class="comment-form__actions">
							<div :style="[remainingChars < 0 ? {color: 'red'} : {color: '#333'}]">[[ remainingChars ]] characters remaining</div>
							<div><button class="btn btn-gray" @click="postComment($event)">Post</button></div>
						</div>
					</form>
					<div v-else class=comment-form--signin>
						<a href="/signin">Sign In</a> or <a href="/signup">Sign Up</a> now to post a comment!
					</div>
					<div v-if="comments.length">
						<comment-entry v-for="comment in comments" v-bind:key="comment.id" v-bind:comment="comment"></comment-entry>
					</div>
				</div>
			`
		});	
	</script>
{% endblock %}